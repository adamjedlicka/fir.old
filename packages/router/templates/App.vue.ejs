<template>
  <suspense>
    <component :is="layout">
      <suspense>
        <component :is="page.component" :key="page.path" :path="path" />
      </suspense>
    </component>
  </suspense>
</template>

<script>
import { computed, defineComponent, useSSRContext, ref, provide } from 'vue'
import { layout, pages } from './Pages'

export default defineComponent({
  setup() {
    const path = ref(import.meta.env.SSR ? useSSRContext().req.originalUrl : window.location.pathname)

    const page = computed(() => {
      for (const page of pages) {
        if (page.path.test(path.value)) return page
      }

      return null
    })

    if (!import.meta.env.SSR) {
      window.onpopstate = () => {
        path.value = window.location.pathname
      }
    }

    provide('$router', {
      push(_path) {
        window.history.pushState('', '', _path)
        path.value = _path
      }
    })

    return {
      path,
      layout,
      page,
    }
  },
})
</script>
